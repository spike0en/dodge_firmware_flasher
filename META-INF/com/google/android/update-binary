#!/sbin/sh
# Functions needed early
ui_print() { $BOOTMODE && echo "$1" || echo -e "ui_print $1\nui_print" >> $OUTFD; }
abort() { ui_print "$1"; ui_print " "; exit 1; }

# Set vars
OUTFD=/proc/self/fd/$2
ZIPFILE="$3"
tmp=/dev/tmp

chooseport() {
  while true; do
    getevent -lc 1 2>&1 | grep VOLUME | grep " DOWN" > $tmp/events
    if (`cat $tmp/events 2>/dev/null | grep VOLUME >/dev/null`); then
      break
    fi
  done
  if (`cat $tmp/events 2>/dev/null | grep VOLUMEUP >/dev/null`); then
    return 0
  else
    return 1
  fi
}

# Detect Magisk Manager/booted flashing
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true || BOOTMODE=false
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true
$BOOTMODE && abort "You need to flash this from Orangefox Recovery!"

set -x
rm -rf $tmp
mkdir -p $tmp
unzip -o "$ZIPFILE" -d $tmp || abort "Failed to extract zip!"
sleep 1

ui_print " "
ui_print "========================================="
ui_print " OnePlus 13 Firmware Flasher"
ui_print "========================================="
ui_print " Device: OnePlus 13 (dodge)"
ui_print " Target FW Build: Check filename"
ui_print " "
ui_print " Based on script by Wishmasterflo,"
ui_print " Modified and adapted by spike0en."
ui_print "========================================="
ui_print " "
ui_print "Continue? Vol+ yes, Vol- no"
chooseport
if [ $? -ne 0 ]; then
  ui_print "User cancelled flashing."
  rm -rf $tmp
  exit 0
fi
ui_print "Proceeding with flash..."

# Flash to both slots unconditionally
ui_print " "
ui_print "Flashing base fw to both slots..."
ui_print " "

# Function to flash a partition to both slots, prompting on error
flash_partition() {
  local partition_name=$1
  local image_file=$2
  local partition_path_a="/dev/block/bootdevice/by-name/${partition_name}_a"
  local partition_path_b="/dev/block/bootdevice/by-name/${partition_name}_b"
  local base_dir="$tmp/firmware-update"
  if [[ "$image_file" == "signal-fix-cn/"* ]]; then
    base_dir="$tmp"
  fi
  local source_image="$base_dir/$image_file"

  ui_print " "
  ui_print "Processing $partition_name..."

  # Check if image file exists
  if [ ! -f "$source_image" ]; then
    ui_print "--> Error: Image file $source_image not found for $partition_name!"
    ui_print "    Press Vol+ to skip flashing this partition and continue,"
    ui_print "    Press Vol- to abort the entire script."
    chooseport
    if [ $? -ne 0 ]; then
      abort "Aborting script due to missing image file and user choice."
    else
      ui_print "--> Skipping $partition_name due to missing image, continuing..."
      return 0
    fi
  fi

  # Flash Slot A
  ui_print "  Flashing $partition_name to slot A..."
  dd if="$source_image" of="$partition_path_a" bs=4k
  if [ $? -ne 0 ]; then
    ui_print "--> Error flashing $partition_name to slot A!"
    ui_print "    Press Vol+ to skip this partition and continue,"
    ui_print "    Press Vol- to abort the entire script."
    chooseport
    if [ $? -ne 0 ]; then
      abort "Aborting script due to slot A error and user choice."
    else
      ui_print "--> Continuing to next partition despite slot A error..."
      return 0
    fi
  fi

  # Flash Slot B
  ui_print "  Flashing $partition_name to slot B..."
  dd if="$source_image" of="$partition_path_b" bs=4k
  if [ $? -ne 0 ]; then
    ui_print "--> Error flashing $partition_name to slot B!"
    ui_print "    Press Vol+ to skip this partition and continue,"
    ui_print "    Press Vol- to abort the entire script."
    chooseport
    if [ $? -ne 0 ]; then
      abort "Aborting script due to slot B error and user choice."
    else
      ui_print "--> Continuing to next partition despite slot B error..."
      return 0
    fi
  fi

  # Confirmation message
  ui_print "  $partition_name flashed successfully to both slots."
}

# Define partition lists
firmware_partitions="abl aop_config aop bluetooth cpucp cpucp_dtb devcfg dsp engineering_cdt featenabler hyp imagefv keymaster modem oplus_sec oplusstanvbk pdp pdp_cdb pvmfw qupfw shrm soccp_dcd soccp_debug splash spuservice tz uefi uefisecapp xbl_config xbl_ramdump xbl"
misc_partitions="boot init_boot vendor_boot dtbo vbmeta vbmeta_system vbmeta_vendor"

# Firmware partition images
ui_print " "
if [ "$IS_CN_MODEL" = "true" ]; then
  ui_print "Flashing Color OS firmware partitions..."
else
  ui_print "Flashing OxygenOS firmware partitions..."
fi
for partition in $firmware_partitions; do
  if [ "$IS_CN_MODEL" = "true" ] && ([ "$partition" = "oplusstanvbk" ] || [ "$partition" = "modem" ]); then
    ui_print "  Skipping $partition for CN model."
    continue
  fi
  flash_partition $partition ${partition}.img
done
ui_print "Firmware flashing complete!"

# Misc partition images
ui_print " "
ui_print "Flashing miscellaneous partitions..."
for partition in $misc_partitions; do
  flash_partition $partition ${partition}.img
done
ui_print "Miscellaneous partition flashing complete!"

# Device model detection for conditional flashing
DEVICE_PRJNAME=$(getprop ro.boot.prjname)
IS_CN_MODEL=false
if [ "$DEVICE_PRJNAME" = "23821" ]; then
  IS_CN_MODEL=true
  ui_print " "
  ui_print "========================================="
  ui_print " CN model detected! This requires signal"
  ui_print " fix if you are currently running OxygenOS."
  ui_print "========================================="
  ui_print " "
fi

# Fix signal for CN models
if [ "$IS_CN_MODEL" = "true" ]; then
  ui_print " "
  ui_print "Flashing CN model specific signal fix running OxygenOS..."
  flash_partition "oplusstanvbk" "signal-fix-cn/oplusstanvbk.img"
  flash_partition "modem" "signal-fix-cn/modem.img"
  ui_print "CN model signal fix has been applied!"
fi

# Cleanup tmp dir
rm -rf /dev/tmp

# Final instruction
ui_print " "
ui_print "You may now proceed with sideloading the ROM!"

exit 0
